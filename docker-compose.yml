services:
  # Router container - central hub for traffic shaping
  router:
    build:
      context: ./router
      dockerfile: Dockerfile
    container_name: router
    hostname: router
    cap_add:
      - NET_ADMIN
      - NET_RAW
    sysctls:
      - net.ipv4.ip_forward=1
    networks:
      management:
        ipv4_address: 172.20.0.2
    volumes:
      - router_config:/config/rules
    restart: unless-stopped

  # InfluxDB for time-series metrics storage
  influxdb:
    image: influxdb:2.7-alpine
    container_name: influxdb
    hostname: influxdb
    ports:
      - "8086:8086"
    networks:
      management:
        ipv4_address: 172.20.0.5
    volumes:
      - influxdb_data:/var/lib/influxdb2
      - influxdb_config:/etc/influxdb2
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=adminpassword
      - DOCKER_INFLUXDB_INIT_ORG=qc
      - DOCKER_INFLUXDB_INIT_BUCKET=metrics
      - DOCKER_INFLUXDB_INIT_RETENTION=30d
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=qc-dev-token-change-in-production
    restart: unless-stopped

  # Backend service - FastAPI with SSE
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: backend
    hostname: backend
    ports:
      - "8000:8000"
    networks:
      management:
        ipv4_address: 172.20.0.3
    environment:
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=qc-dev-token-change-in-production
      - INFLUXDB_ORG=qc
      - INFLUXDB_BUCKET=metrics
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock  # Access to Docker daemon
      - ./backend/src:/app/src  # Development hot-reload
    depends_on:
      - router
      - influxdb
    restart: unless-stopped

  # Frontend service - React with Vite
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend
    hostname: frontend
    ports:
      - "3000:3000"
    networks:
      management:
        ipv4_address: 172.20.0.4
    environment:
      - VITE_BACKEND_URL=http://localhost:8000
    volumes:
      - ./frontend/src:/app/src  # Development hot-reload
      - ./frontend/public:/app/public
    depends_on:
      - backend
    restart: unless-stopped

networks:
  # Management network for backend access to all containers
  management:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24

  # NOTE: Client networks are now created dynamically by the backend
  # when devices are synced. See ClusterManager UI to create devices.

volumes:
  router_config:
    driver: local
  influxdb_data:
    driver: local
  influxdb_config:
    driver: local
